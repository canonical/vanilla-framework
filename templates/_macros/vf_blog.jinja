{% from "_macros/shared/vf_section_top_rule.jinja" import vf_section_top_rule %}
{% from "_macros/shared/vf_article_block.jinja" import vf_blog_article_block %}

# Params
# - truncation_config:
# - article_config: A dictionary with the article configuration.
# - "title": A dictionary with "text" and optional "link" (a dictionary of link attributes for the title).
# - "image": A dictionary with "attrs" dict containing "src", "alt", and other image attributes.
#          The image is automatically wrapped in a 16:9 cover image container and passed to
#          vf_blog_article_block as before_title_html. A fallback image is used if no image
#          is provided (can be overridden via fallback_attrs).
# - "description": A dictionary with "text", and "truncation_length" (an integer for max characters before truncation).
# - "metadata": A dictionary with:
#   - "authors": A list of author objects, each with "text" and optional "link" (a dictionary of link attributes)
#   - "date": A dictionary with "text" and optional "attrs" (a dictionary of time element attributes)
{%- macro _blog_article(article_config={}, truncation_config={}, template_mode=False, fallback_image_url="https://assets.ubuntu.com/v1/94c82a15-blog_fallback_image.png") -%}
  {% if not template_mode %}
    {%- set default_image = {
        'attrs': {
          'src': fallback_image_url,
          'alt': 'Blog fallback image'
        }
    } -%}

    {%- set input_attrs = article_config.get('image', {}).get('attrs', {}) -%}
    {%- set _ = default_image.attrs.update(input_attrs) -%}
    {%- set _ = article_config.update({'image': default_image}) -%}
    {#- Merge the user's attributes over the defaults -#}
    {%- set img_attrs = article_config.get("image", {}).get("attrs", {}) -%}
    {#- Add article-image class to the image for compatibility with template tools -#}
    {%- set img_class = img_attrs.get("class", "") -%}
    {%- if img_class -%}
      {%- set img_attrs = img_attrs.update({"class": img_class ~ " article-image"}) or img_attrs -%}
    {%- else -%}
      {%- set img_attrs = img_attrs.update({"class": "article-image"}) or img_attrs -%}
    {%- endif -%}
    {%- set ns = namespace(image_html="<img") -%}
    {%- for attr, value in img_attrs.items() -%}
        {%- set ns.image_html = ns.image_html + " " + attr + "=\"" + value + "\"" -%}
    {%- endfor -%}
    {%- set image_html = ns.image_html + ">" -%}
    {%- set _ = article_config.update({'before_title_html': image_html}) -%}
  {% else %}
    {%- set _ = article_config.update({'before_title_html': '<div class="article-image"></div>'}) -%}
  {% endif %}

    {{- vf_blog_article_block(article_config=article_config, truncation_config=truncation_config, attrs={"class": "grid-col-2"}, template_mode=template_mode) -}}

{%- endmacro -%}

# Params
# title: A dictionary with "text" and optional "link" (a dictionary of link attributes for the title).
# articles: A list of article dictionaries, each with "title", "image", "description", and "metadata".
# template_config:
#   - enabled: A boolean to enable or disable the template mode.
#   - template_container_id: A string for the id of the container to use for dynamic loading scenarios.
#   - template_id: A string for the id of the template to use for dynamic loading scenarios.
#   - layout: Layout to apply to the template. Options are "3-blocks" and "4-blocks".
# padding: Type of padding to apply to the pattern - "deep", "shallow", "default" (default is "default").
# top_rule_variant: Type of HR to render at the top of the pattern. "default" | "muted" (default is "default").
{% macro vf_blog(
    title={},
    articles=[],
    template_config={},
    padding="default",
    top_rule_variant="default",
    truncation_config={},
    fallback_image_url="https://assets.ubuntu.com/v1/94c82a15-blog_fallback_image.png"
) -%}
    {%- set padding = padding | trim -%}
    {%- if padding not in ["deep", "shallow", "default"] -%}
        {%- set padding = "default" -%}
    {%- endif -%}

    {%- set padding_classes = "p-section--" + padding -%}
    {%- if padding == "default" -%}
        {%- set padding_classes = "p-section" -%}
    {%- endif -%}

    {%- if articles | length == 3 -%}
        {%- set layout = "3-blocks" -%}
    {%- elif articles | length == 4 -%}
        {%- set layout = "4-blocks" -%}
    {%- endif -%}

    {%- set template_mode = template_config.get("enabled", False) -%}

    {%- if template_mode and (not articles | length) -%}
        {%- set layout = template_config.get("layout", "4-blocks") -%}
    {%- endif -%}

    {%- if layout not in ["3-blocks", "4-blocks"] -%}
        {%- set layout = "4-blocks" -%}
    {%- endif -%}

    {%- if not truncation_config -%}
        {%- set truncation_config = {
            "description": {
                "max_chars": None if template_mode else 180,
                "overflow_text": "â€¦"
            }
        } -%}
    {%- endif -%}

    <section class="{{ padding_classes }}">
        <div class="p-blog {% if layout == "4-blocks" %}has-4-blocks{% endif %} grid-row">
            {{ vf_section_top_rule(top_rule_variant) }}
            <div class="p-blog__title">
                <h4 class="p-muted-heading">
                    {%- if title.get("link") -%}
                        <a
                        {% for attr, value in title.get("link", {}).items() -%}
                            {{ attr }}="{{ value }}"
                        {%- endfor -%}
                        >
                    {%- endif -%}
                    {{ title.get("text", "Blog Title") }}
                    {%- if title.get("link") -%}
                        </a>
                    {%- endif -%}
                </h4>
            </div>

            {%- if template_config.get("enabled", False) -%}
                <div id="{{ template_config.get("template_container_id", "articles") }}" class="p-blog__template-container"></div>
                <template style="display: none;" id="{{ template_config.get("template_id", "template") }}">
                    {{- _blog_article(template_mode=True) -}}
                </template>
            {%- else -%}
                {%- for article in articles -%}
                    {{- _blog_article(article_config=article, truncation_config=truncation_config, fallback_image_url=fallback_image_url) -}}
                {%- endfor -%}
            {%- endif -%}

        </div>
    </section>

{% endmacro %}