/*
  @classreference
    Article block:
      .p-article-block:
        Container for blog article content
      .p-article-block__item:
        Individual content block within article block
      .p-article-block__image:
        An image within an article block
      .p-article-block__title:
        The title of the article block
      .p-article-block__metadata:
        Metadata container
      .p-article-block__metadata-item:
        Individual metadata item with middot separator between items
*/

@use 'sass:math';

@mixin vf-p-article-block {
  .p-article-block {
    display: grid;
    // image, title, desc/excerpt, metadata
    grid-row: span 4;
    grid-template-rows: subgrid;
    // the section that wraps the items already has bottom padding defined, so the last row of items must have collapsed bottom margin to avoid duplicating spacing.
    // small screens - the last item gets collapsed bottom margin
    @media screen and (width < $threshold-4-small-4-med-col) {
      &:last-child {
        .p-article-block__item:last-child *:last-child {
          margin-bottom: #{$sp-unit - map-get($settings-text-p, nudge)};
        }
      }
    }

    // medium screens - the last two items get collapsed bottom margin
    @media screen and ($threshold-4-small-4-med-col <= width < $threshold-4-8-col) {
      &:nth-last-child(-n + 2) {
        .p-article-block__item:last-child *:last-child {
          margin-bottom: #{$sp-unit - map-get($settings-text-p, nudge)};
        }
      }
    }

    // large screen - all items get collapsed bottom margin
    @media screen and (width >= $threshold-4-8-col) {
      // 4 items per row, only 4 items allowed - items have no margin at all
      .p-article-block__item:last-child *:last-child {
        margin-bottom: #{$sp-unit - map-get($settings-text-p, nudge)};
      }
    }
  }

  .p-article-block__image {
    margin-bottom: $spv--small;
  }

  .p-article-block__title,
  .p-article-block__description,
  .p-article-block__metadata {
    @extend %paragraph;
  }

  /** collapse padding and margin of block items that have no content */
  .p-article-block__image,
  .p-article-block__title,
  .p-article-block__description,
  .p-article-block__metadata {
    &:empty,
    /* metadata and image wrap around further items, so we need to check for presence of non-empty children */
    &.p-article-block__metadata:not(:has(.p-article-block__metadata-item > *:not(:empty))),
    .p-article-block__image:not(:has(> *:not(:empty))) {
      &,
      // *nothing* should have bottom margin or top padding if the item is empty.
      * {
        margin-bottom: 0;
        padding-top: 0;
      }
    }
  }

  /*
    Add a middot between non-empty metadata items
    The metadata-items are wrappers around child elements that are **always** rendered, so that dynamic content has slots to populate items into.
    We don't know at build time if there will be any content.
    So, we use :has() to target `p-article-block__metadata-item` elements that have at least one non-empty child element, without having to target any specific child selectors here.
    Note that this requires careful management of whitespace within the metadata items. Extra whitespace can cause elements with no children to be considered non-empty and unnecessarily render a middot.
   */
  .p-article-block__metadata-item:has(> *:not(:empty)) {
    @include vf-inline-list-item;

    margin-right: $sph--x-small;

    & ~ &::before {
      content: '\2022';
      position: relative;
    }
  }
}
